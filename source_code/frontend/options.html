<!DOCTYPE html>
<html>
<head>
    <title>YT 字幕增強器 - 設定</title>
    <link rel="stylesheet" href="popup.css">
    <meta charset="UTF-8">
</head>
<body style="width: auto; max-width: 600px; margin: 0 auto; padding: 20px;">
    
    <div id="options-toast"></div>

    <header class="header" style="margin-bottom: 20px;">
        <h1>YT 字幕增強器 - 進階管理後台</h1>
        <span class="version-badge">v2.1.0</span>
    </header>

    <div class="tab-nav">
        <button class="tab-link active" data-tab="tab-main">主要設定</button>
        <button class="tab-link" data-tab="tab-diag">診斷與日誌</button>
    </div>

    <div id="tab-main" class="tab-content active">
        <div class="card" id="tier-1-card">
            <h2 class="card-title">語言清單 A：原文顯示語言 (零成本模式)</h2>
            <p class="card-hint">設定您能看懂的語言。當影片有這些語言字幕時，系統將不發送 API 請求，直接顯示原文。</p>
            
            <div id="tier-1-badge-container" class="badge-container">
                </div>

            <button id="tier-1-add-button" class="button-secondary add-lang-button">+ 新增語言</button>
            
            <div class="card-hint info-box" style="margin-top: 16px;">
                💡 <strong>節費提示：</strong> 當字幕是您設定的語言時，系統會直接顯示原文，不會消耗 API 配額。
            </div>
        </div>
        <div class="card" id="tier-2-card">
            <h2 class="card-title">語言清單 B：自動翻譯與 Prompt 管理</h2>
            <p class="card-hint">設定需要自動翻譯的語言，並為每個語言自訂 Prompt。系統會依列表順序檢查並觸發第一個匹配的語言。</p>
            
            <ul id="tier-2-accordion-list" class="sortable-list accordion-list">
                </ul>

            <button id="tier-2-add-button" class="button-secondary add-lang-button">+ 新增語言</button>

            <div class="card-hint warning-box" style="margin-top: 16px;">
                ⚠️ <strong>優先級說明：</strong> 系統會依序檢查列表，並觸發第一個匹配的翻譯。拖曳項目可調整優先序。
            </div>
        </div>
        <div class="card">
            <h2 class="card-title">模型偏好設定 (可拖曳排序)</h2>
            <p class="card-hint">點擊選取模型，使用箭頭按鈕在兩個列表間移動。僅「已選用模型」列表中的模型會被調用，您可以拖曳它們來調整嘗試順序。</p>
            
            <h3 class="card-subtitle">已選用模型 (會被調用)</h3>
            <ul id="selected-models" class="model-list sortable-list"></ul>

            <div class="model-controls">
                <button id="add-model" title="新增選取">&#9650; (加入選用)</button>
                <button id="remove-model" title="移除選取">&#9660; (移出選用)</button>
            </div>

            <h3 class="card-subtitle">可用模型</h3>
            <ul id="available-models" class="model-list"></ul>
        </div>
        <div class="card">
            <h2 class="card-title">進階外觀設定</h2>
            <div class="setting-row">
                <label for="fontFamilySelect">字體選擇</label>
                <select id="fontFamilySelect">
                    <optgroup label="通用">
                        <option value="YouTube Noto, Roboto, sans-serif">YouTube 預設</option>
                        <option value="Noto Sans TC, sans-serif">思源黑體 (推薦)</option>
                    </optgroup>
                    <optgroup label="Windows">
                        <option value="Microsoft JhengHei, sans-serif">微軟正黑體 (預設)</option>
                    </optgroup>
                </select>
            </div>
        </div>
        <div id="language-search-popover" class="popover-backdrop" style="display: none;">
            <div class="popover-content">
                <h3>新增語言</h3>
                <input type="text" id="language-search-input" placeholder="搜尋語言 (例如: 日文, ja, Japanese)...">
                <ul id="language-search-results">
                    </ul>
            </div>
        </div>
    </div>
    
    <div id="tab-diag" class="tab-content">
        <div class="card">
            <h2 class="card-title">Google API 金鑰管理</h2>
            <p class="card-hint">
                您的金鑰將安全儲存在瀏覽器本地，絕不會上傳至任何伺服器。
                <br>
                您可以新增多個金鑰作為備援，系統會依照列表順序嘗試使用。
            </p>
            
            <h3 class="card-subtitle" style="margin-top: 0;">新增金鑰</h3>
            <div class="api-key-form">
                <input type="text" id="apiKeyNameInput" placeholder="金鑰名稱 (例如: 個人金鑰)" style="flex-grow: 1;">
                <input type="password" id="apiKeyInput" placeholder="請在此貼上您的 Google API Key" style="flex-grow: 2; margin-left: 8px;">
                <button id="addApiKeyButton" class="button-primary" style="width: auto; margin-left: 8px;">新增</button>
            </div>

            <h3 class="card-subtitle">已儲存的金鑰</h3>
            <ul id="apiKeyList" class="api-key-list">
                </ul>
        </div>
        <div class="card">
            <h2 class="card-title">資料管理</h2>
            <button id="clearCacheButton" class="button-secondary" style="width: 100%;">清除所有影片的翻譯暫存</button>
        </div>

        <div class="card">
            <h2 class="card-title">API Key 診斷</h2>
            <p class="card-hint">
                此功能僅透過發送一個極小的測試請求來驗證金鑰的<b>基本有效性</b>（即金鑰是否存在且未被禁用）。
                <br>
                它<b>無法</b>檢測金鑰的剩餘用量或是否已達每日配額上限。
            </p>
            <button id="diagnoseKeysButton" class="button-primary" style="width: 100%;">開始診斷所有金鑰</button>
            <div id="diagnose-results"></div>
        </div>
        
        <div class="card">
            <h2 class="card-title">狀態日誌 (僅顯示當前分頁的持續性錯誤)</h2>
            <div id="error-log-container">
                <p class="log-placeholder">目前沒有持續性錯誤紀錄。</p>
            </div>
        </div>
    </div>

    <script src="popup.js"></script>
</body>
</html>