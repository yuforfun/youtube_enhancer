<!DOCTYPE html>
<html>
<head>
    <title>YT 字幕增強器 - 設定</title>
    <link rel="stylesheet" href="popup.css">
    <meta charset="UTF-8">
</head>
<body style="width: auto; max-width: 600px; margin: 0 auto; padding: 20px;">
    
    <div id="options-toast"></div>

    <header class="header" style="margin-bottom: 20px;">
        <h1>YT 字幕增強器 - 進階管理後台</h1>
        <span class="version-badge">v4.0.2</span> </header>

    <div class="tab-nav">
        <button class="tab-link active" data-tab="tab-main">主要設定</button>
        <button class="tab-link" data-tab="tab-diag">診斷與日誌</button>
    </div>

    <div id="tab-main" class="tab-content active">
        
        <div class="card">
            <h2 class="card-title">功能運作說明與限制</h2>
            <p class="card-hint" style="margin-top: 16px;">
                <b>[基本前提]</b>您的影片<b>必須至少提供一種字幕軌道</b> (包含 YouTube 自動產生的字幕)，本擴充功能才能進行攔截與翻譯。
            </p>
            <p class="card-hint" style="margin-top: 16px;">
                <b>啟用擴充功能後，系統會自動檢查您在「進階管理後台」設定的語言清單：</b>
            </p>
            <ul class="hint-list"> <li>如果影片語言在您的<b>「清單 A (原文顯示)」</b>中，將僅顯示原文。</li>
                <li>如果影片語言在您的<b>「清單 B (自動翻譯)」</b>中，將自動展示雙語字幕。</li>
                <li>如果皆未命中，系統會顯示原文，並在播放器右上角提供一個<b>「翻譯」</b>按鈕。</li>
            </ul>

            <p class="card-hint" style="margin-top: 16px;">
                <b>如果字幕顯示異常或失敗，請嘗試以下步驟：</b>
            </p>

            <ol class="hint-list"> <li><b>手動切換字幕：</b> 嘗試點選播放器的字幕(CC)按鈕，切換到「關閉」，然後再切回您要的語言。此操作會強制擴充功能重新執行決策。</li>
                <li><b>重新整理頁面：</b> 這是最可靠的重置方法。由於系統有快取，您重新整理後不會遺失已翻譯的進度。</li>
                <li><b>檢查後台設定：</b> 前往「進階管理後台」，確認您的「語言清單 A/B」與「API 金鑰」是否已正確配置。</li>
            </ol>
            
            <hr style="margin: 20px 0; border-color: #e4e4e7;">
            <p class="card-hint" style="margin: 0;">
                <a href="https://github.com/yuforfun/youtube_enhancer/wiki" target="_blank" style="color: var(--accent-color); font-weight: 600; text-decoration: none; font-size: 13px;">查看詳細的使用說明、FAQ 與完整功能列表 →</a>
            </p>
            </div>
        <div class="card">
            <h2 class="card-title">進階外觀設定</h2>
            <div class="setting-row">
                <label for="fontFamilySelect">字體選擇</label>
                <select id="fontFamilySelect">
                    <optgroup label="通用">
                        <option value="YouTube Noto, Roboto, sans-serif">YouTube 預設</option>
                        <option value="Noto Sans TC, sans-serif">思源黑體 (推薦)</option>
                    </optgroup>
                    <optgroup label="Windows">
                        <option value="Microsoft JhengHei, sans-serif">微軟正黑體 (預設)</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="card" id="tier-1-card">
            <h2 class="card-title">語言清單 A：原文顯示語言</h2>
            <p class="card-hint">設定您能看懂的語言。當影片有這些語言字幕時，系統將直接顯示依列表順序檢查並觸發匹配的語言。</p>
            
            <ul id="tier-1-badge-list" class="sortable-list badge-list">
                </ul>

            <button id="tier-1-add-button" class="button-secondary add-lang-button">+ 新增語言</button>
            
            <div class="card-hint info-box" style="margin-top: 16px;">
                💡 <strong>提示：</strong> 當字幕是您設定的語言時，系統會直接顯示原文，不會消耗 API 配額。
            </div>
        </div>

        <div class="card" id="tier-2-card">
            <h2 class="card-title">語言清單 B：自動翻譯與 Prompt 管理</h2>
            <p class="card-hint">設定需要自動翻譯的語言，並為每個語言自訂 Prompt。系統會依列表順序檢查並觸發第一個匹配的語言。</p>
            
            <ul id="tier-2-accordion-list" class="sortable-list accordion-list">
                </ul>

            <button id="tier-2-add-button" class="button-secondary add-lang-button">+ 新增語言</button>

            <div class="card-hint warning-box" style="margin-top: 16px;">
                ⚠️ <strong>優先級說明：</strong> 系統會依序檢查列表，並觸發第一個匹配的翻譯。拖曳項目可調整優先序。
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">模型偏好設定 (可拖曳排序)</h2>
            <p class="card-hint">
                系統將依照您在「已選用模型」列表中的順序（由上至下）依序嘗試。
                <br>
                您可以從下方「可添加模型」中點擊 `+` 將其加入列表。
            </p>
            
            <h3 class="card-subtitle">已選用模型 (會被調用)</h3>
            <ul id="selected-models" class="model-list sortable-list">
            </ul>

            <h3 class="card-subtitle">可添加模型</h3>
            <div id="available-model-pills" class="model-pills-container">
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Google API 金鑰管理</h2>
            
            <p class="card-hint" style="margin-bottom: 12px;">
                您必須自行前往 <b><a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" style="color: var(--accent-color); font-weight: 600; text-decoration: none;">Google AI Studio</a></b> 申請免費的 Gemini API Key。
                <br>
                本擴充功能不提供金鑰，所有翻譯請求均由您自己的金鑰發起，請注意您的用量。
            </p>
            <p class="card-hint">
                設定金鑰後，將存儲在瀏覽器本地，並且可以設定多組金鑰來避免單一金鑰的配額限制。
            </p>

            <p class="card-hint warning-box" style="margin-top: 12px; padding: 10px; line-height: 1.6;">
                ⚠️ <strong>金鑰儲存機制：</strong>
                <br>
                1. [新增]：填入名稱和金鑰後，請<b>點擊頁面空白處</b>，系統即會自動儲存。
                <br>
                2. [更新]：修改已儲存的金鑰後，點擊空白處系統即會自動儲存。您會看到該列變為可編輯的密碼欄狀態，代表儲存成功。
                <br>
                3. [顯示]：點擊密碼輸入框，即可顯示完整的金鑰。
            </p>
            <h3 class="card-subtitle" style="margin-top: 12px;">金鑰列表 (輸入、儲存)</h3>
            
            <ul id="apiKeyList" class="api-key-list">
                </ul>
            
            <h2 class="card-title" style="margin-top: 24px;">API Key 診斷</h2>
            <p class="card-hint">
                此功能僅透過發送一個極小的測試請求來驗證金鑰的<b>基本有效性</b>（即金鑰是否存在且未被禁用）。
                <br>
                它<b>無法</b>檢測金鑰的剩餘用量或是否已達每日配額上限。
            </p>
            <button id="diagnoseKeysButton" class="button-primary" style="width: 100%;">開始診斷所有金鑰</button>
            <div id="diagnose-results"></div>
        </div>

        <div id="language-search-popover" class="popover-backdrop" style="display: none;">
            <div class="popover-content">
                <h3>新增語言</h3>
                <input type="text" id="language-search-input" placeholder="搜尋語言 (例如: 日文, ja, Japanese)...">
                <ul id="language-search-results">
                    </ul>
            </div>
        </div>
    </div>
    
    <div id="tab-diag" class="tab-content">
        
        <div class="card">
            <h2 class="card-title">資料管理</h2>
            <button id="clearCacheButton" class="button-secondary" style="width: 100%;">清除所有影片的翻譯暫存</button>
        </div>
        
        <div class="card">
            <h2 class="card-title">狀態日誌 (僅顯示當前分頁的持續性錯誤)</h2>
            <div id="error-log-container">
                <p class="log-placeholder">目前沒有持續性錯誤紀錄。</p>
            </div>
        </div>
    </div>

    <script src="popup.js"></script>
</body>
</html>